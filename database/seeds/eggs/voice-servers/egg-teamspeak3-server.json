#!/bin/bash
# TS3 Installation Script
#
# Server Files: /mnt/server
apt -y update
apt -y --no-install-recommends install tar curl jq bzip2 grep sed

cd /mnt/server

for FILE in logs/ts3server*_0.log
do
	if [ ! -f "$FILE" ]; then
		VERSION=$(curl -s 'https://www.teamspeak.com/versions/server.json' | jq -r '.linux.x86_64.version')
		LATESTTS3RELEASELINK=$(curl -s 'https://www.teamspeak.com/versions/server.json' | jq -r '.linux.x86_64.mirrors."teamspeak.com"')
		echo -e "\nDownloading TS3 Version $VERSION\n"
		curl $LATESTTS3RELEASELINK | tar xj --strip-components=1
	else
		if [ "${UPDATE}" -eq 1 ]; then
			VERSION=$(curl -s 'https://www.teamspeak.com/versions/server.json' | jq -r '.linux.x86_64.version')
			LATESTTS3RELEASELINK=$(curl -s 'https://www.teamspeak.com/versions/server.json' | jq -r '.linux.x86_64.mirrors."teamspeak.com"')
			echo -e "\nDownloading TS3 Version $VERSION\n"
			curl $LATESTTS3RELEASELINK | tar xj --strip-components=1
		else
			INSTALLEDVERSION=$(cat $(find ./* -name "ts3server*_0.log" 2> /dev/null | sort | grep -Ev "${rootdir}/.ts3version" | tail -1) | grep -Eo "TeamSpeak 3 Server ((\.)?[0-9]{1,3}){1,3}\.[0-9]{1,3}" | grep -Eo "((\.)?[0-9]{1,3}){1,3}\.[0-9]{1,3}" | sort -V | tail -1)	
			OLDTS3RELEASELINK=$(curl -s 'https://www.teamspeak.com/versions/server.json' | jq -r '.linux.x86_64.mirrors."teamspeak.com"' | sed -r "s/((\.)?[0-9]{1,3}){1,3}\.[0-9]{1,3}+/$INSTALLEDVERSION/g")
			echo -e "\nDownloading TS3 Version $INSTALLEDVERSION\n"
			curl $OLDTS3RELEASELINK | tar xj --strip-components=1
		fi
	fi
	break
done

# Accept license
if [ ! -f ".ts3server_license_accepted" ]; then
	touch ".ts3server_license_accepted"
fi

if [ ! -f "ts3server.ini" ]; then
    echo "Creating default config for teamspeak"
    echo 'machine_id=
default_voice_port=9987
voice_ip=
licensepath=
filetransfer_port=30033
filetransfer_ip=
query_port=10011
query_ip=0.0.0.0, ::
query_ip_whitelist=query_ip_whitelist.txt
query_ip_blacklist=query_ip_blacklist.txt
dbplugin=ts3db_sqlite3
dbpluginparameter=
dbsqlpath=sql/
dbsqlcreatepath=create_sqlite/
dbconnections=10
logpath=logs
logquerycommands=0
dbclientkeepdays=30
logappend=0
query_skipbruteforcecheck=0
query_buffer_mb=20
http_proxy=
license_accepted=1
serverquerydocs_path=serverquerydocs/
query_ssh_ip=0.0.0.0, ::
query_ssh_port=10022
query_protocols=raw,ssh
query_ssh_rsa_host_key=ssh_host_rsa_key
query_timeout=300' > ts3server.ini
fi
