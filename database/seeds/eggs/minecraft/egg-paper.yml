# DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY PTERODACTYL PANEL - PTERODACTYL.IO
meta:
  version: PTDL_v1
exported_at: '2019-08-01T04:49:37-04:00'
name: Paper
author: parker@pterodactyl.io
description: 'High performance Spigot fork that aims to fix gameplay and mechanics inconsistencies.'
image: 'quay.io/pterodactyl/core:java'
startup: 'java -Xms128M -Xmx{{SERVER_MEMORY}}M -Dterminal.jline=false -Dterminal.ansi=true -jar {{SERVER_JARFILE}}'
config:
  files: |
    server.properties:
      parser: properties
      find:
        server-ip: 0.0.0.0
        server-port: '{{server.build.default.port}}'
    
  startup: |
    done: ')! For help, type '
    userInteraction:
      - 'Go to eula.txt for more info.'
    
  logs: '{  }'
  stop: stop
scripts:
  installation:
    script: |
      #!/bin/ash
      # Paper Installation Script
      #
      # Server Files: /mnt/server
      apk add --no-cache --update curl jq
      
      if [ -n "${DL_PATH}" ]; then
          echo -e "using supplied download url"
          DOWNLOAD_URL=`eval echo $(echo ${DL_PATH} | sed -e 's/{{/${/g' -e 's/}}/}/g')`
      else
          VER_EXISTS=`curl -s https://papermc.io/api/v1/paper | jq -r --arg VERSION $MINECRAFT_VERSION '.versions[] | IN($VERSION)' | grep true`
          LATEST_PAPER_VERSION=`curl -s https://papermc.io/api/v1/paper | jq -r '.versions' | jq -r '.[0]'`
          
          if [ "${VER_EXISTS}" == "true" ]; then
              echo -e "Version is valid. Using version ${MINECRAFT_VERSION}"
          else
              echo -e "Using the latest paper version"
              MINECRAFT_VERSION=${LATEST_PAPER_VERSION}
          fi
          
          BUILD_EXISTS=`curl -s https://papermc.io/api/v1/paper/${MINECRAFT_VERSION} | jq -r --arg BUILD ${BUILD_NUMBER} '.builds.all[] | IN($BUILD)' | grep true`
          LATEST_PAPER_BUILD=`curl -s https://papermc.io/api/v1/paper/${MINECRAFT_VERSION} | jq -r '.builds.latest'`
          
          if [ "${BUILD_EXISTS}" == "true" ] || [ ${BUILD_NUMBER} == "latest" ]; then
              echo -e "Build is valid. Using version ${BUILD_NUMBER}"
          else
              echo -e "Using the latest paper build"
              BUILD_NUMBER=${LATEST_PAPER_BUILD}
          fi
          
          echo "Version being downloaded"
          echo -e "MC Version: ${MINECRAFT_VERSION}"
          echo -e "Build: ${BUILD_NUMBER}"
          DOWNLOAD_URL=https://papermc.io/api/v1/paper/${MINECRAFT_VERSION}/${BUILD_NUMBER}/download 
      fi
      
      cd /mnt/server
      
      echo -e "running curl -o ${SERVER_JARFILE} ${DOWNLOAD_URL}"
      
      if [ -f ${SERVER_JARFILE} ]; then
          mv ${SERVER_JARFILE} ${SERVER_JARFILE}.old
      fi
      
      curl -o ${SERVER_JARFILE} ${DOWNLOAD_URL}
      
      if [ ! -f server.properties ]; then
          echo -e "Downloading MC server.properties"
          curl -o server.properties https://raw.githubusercontent.com/parkervcp/eggs/master/minecraft_java/server.properties
      fi
      
    container: 'alpine:3.9'
    entrypoint: ash
variables:
  -
    name: 'Minecraft Version'
    description: |
      The version of minecraft to download. 
      
      Leave at latest to always get the latest version. Invalid versions will default to latest.
      
    env_variable: MINECRAFT_VERSION
    default_value: latest
    user_viewable: 1
    user_editable: 0
    rules: 'nullable|string|max:20'
  -
    name: 'Server Jar File'
    description: 'The name of the server jarfile to run the server with.'
    env_variable: SERVER_JARFILE
    default_value: server.jar
    user_viewable: 1
    user_editable: 1
    rules: 'required|string|max:20'
  -
    name: 'Download Path'
    description: 'A URL to use to download a server.jar rather than the ones in the install script. This is not user viewable.'
    env_variable: DL_PATH
    default_value: ''
    user_viewable: 0
    user_editable: 0
    rules: nullable|string
  -
    name: 'Build Number'
    description: |
      The build number for the paper release.
      
      Leave at latest to always get the latest version. Invalid versions will default to latest.
      
    env_variable: BUILD_NUMBER
    default_value: latest
    user_viewable: 1
    user_editable: 0
    rules: 'required|string|max:20'
